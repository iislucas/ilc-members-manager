@if (editableSchool(); as s) {
  <div class="edit-form">
    <div class="edit-form-header" (click)="toggle($event)">
      <div class="identifier">
        @if (s.schoolId) {
          <span>{{ s.schoolId }}</span>
        }
      </div>
      <div class="name">
        @if (s.schoolName.trim() === "") {
          [Name needs to be entered]
        }
        {{ s.schoolName }}
        @if (isDirty()) {
          <span>*</span>
        }
      </div>
      <div class="city-or-country">
        <span class="city">{{ s.schoolCity }}, </span
        ><span class="country">{{ s.schoolCountry }}</span>
      </div>
      <div class="unfold-button">
        <app-icon [name]="collapsed() ? 'expand_more' : 'expand_less'" />
      </div>
    </div>

    @if (!collapsed()) {
      <form #schoolForm="ngForm" (ngSubmit)="saveSchool()">
        <div class="form-section">
          @if (userIsSchoolManager()) {
            <p class="members-link" (click)="gotoMembers()">Manage Members</p>
          }
          <h3>School Details</h3>
          <label for="schoolName">School Name</label>
          <div class="rhs">
            <input
              class="long"
              type="text"
              id="schoolName"
              name="schoolName"
              [(ngModel)]="s.schoolName"
              (ngModelChange)="updateSchool()"
              #schoolName="ngModel"
              required
              [disabled]="!userIsAdmin()"
            />
            @if (schoolName.invalid) {
              <div class="error-message">School Name is required.</div>
            }
          </div>

          <label for="schoolId">School ID</label>
          <div class="rhs">
            <app-id-assignment
              [initAssignment]="schoolIdAssignment()"
              [canBeUnset]="false"
              [expectedNextId]="expectedNextSchoolId()"
              [canEdit]="userIsAdmin()"
              (assignment)="handleSchoolIdAssignmentChange($event)"
            ></app-id-assignment>
            @if (isDupSchoolId()) {
              <div class="error-message">This school ID is already in use.</div>
            }
          </div>

          <label for="schoolAddress" class="align-top">Address</label>
          <div class="rhs">
            <textarea
              class="long"
              id="schoolAddress"
              name="schoolAddress"
              [(ngModel)]="s.schoolAddress"
              (ngModelChange)="updateSchool()"
              [disabled]="!userIsAdmin() && !userIsSchoolManager()"
            ></textarea>
          </div>

          <label for="schoolCity">City</label>
          <div class="rhs">
            <input
              type="text"
              id="schoolCity"
              name="schoolCity"
              [(ngModel)]="s.schoolCity"
              (ngModelChange)="updateSchool()"
              [disabled]="!userIsAdmin()"
            />
          </div>

          <label for="schoolZipCode">Zip Code</label>
          <div class="rhs">
            <input
              type="text"
              id="schoolZipCode"
              name="schoolZipCode"
              [(ngModel)]="s.schoolZipCode"
              (ngModelChange)="updateSchool()"
              [disabled]="!userIsAdmin() && !userIsSchoolManager()"
            />
          </div>

          <label for="schoolCountry">Country</label>
          <div class="rhs">
            <input
              type="text"
              id="schoolCountry"
              name="schoolCountry"
              [(ngModel)]="s.schoolCountry"
              (ngModelChange)="updateSchool()"
              [disabled]="!userIsAdmin()"
            />
          </div>

          <label for="schoolWebsite">Website</label>
          <div class="rhs">
            <input
              class="long"
              type="text"
              id="schoolWebsite"
              name="schoolWebsite"
              [(ngModel)]="s.schoolWebsite"
              (ngModelChange)="updateSchool()"
              [disabled]="!userIsAdmin() && !userIsSchoolManager()"
            />
          </div>

          <h3>Management</h3>
          <label for="owner">Owner</label>
          <div class="rhs">
            <app-autocomplete
              name="owner"
              [searchableSet]="membersService.instructors"
              [placeholder]="'Search instructor for owner'"
              [displayFns]="instructorDisplayFns"
              [initSearchTerm]="s.owner"
              (textUpdated)="s.owner = $event; updateSchool()"
              [disabled]="!userIsAdmin()"
            ></app-autocomplete>
            @if (s.owner === "") {
              <div class="error-message">No owner set</div>
            } @else if (
              membersService.instructors.entriesMap().get(s.owner);
              as ownerData
            ) {
              <div class="note">{{ ownerData.name }}</div>
            } @else {
              <div class="error-message">
                Invalid Owner (Instructor) ID:
                <span class="identifier-chip">{{ s.owner }}</span>
              </div>
            }
          </div>

          <label class="align-top" for="managers">Managers</label>
          <div class="rhs">
            @for (managerMemberId of s.managers; track $index; let i = $index) {
              <div class="member-search-with-details" id="managers">
                <div class="oneLine">
                  <app-autocomplete
                    name="owner"
                    [searchableSet]="membersService.instructors"
                    [placeholder]="'Search instructor for owner'"
                    [displayFns]="instructorDisplayFns"
                    [initSearchTerm]="s.managers[i]"
                    (textUpdated)="s.managers[i] = $event; updateSchool()"
                    [disabled]="!userIsAdmin() && !userIsSchoolManager()"
                  ></app-autocomplete>
                  <button
                    class="icon-only-button"
                    type="button"
                    (click)="removeManager(i); updateSchool()"
                    [disabled]="!userIsAdmin() && !userIsSchoolManager()"
                  >
                    <app-icon name="close" />
                  </button>
                </div>
                @if (s.owner === "") {
                  <div class="error-message">No owner set</div>
                } @else if (
                  membersService.instructors.entriesMap().get(s.managers[i]);
                  as managerData
                ) {
                  <div class="note">{{ managerData.name }}</div>
                } @else {
                  <div class="error-message">
                    Invalid Owner (Instructor) ID:
                    <span class="identifier-chip">{{ s.managers[i] }}</span>
                  </div>
                }
              </div>
            }
            <button
              type="button"
              (click)="s.managers.push(''); updateSchool()"
              [disabled]="!userIsAdmin() && !userIsSchoolManager()"
            >
              Add Manager
            </button>
          </div>
        </div>

        @if (errorMessage().length > 0) {
          <div class="error-container">
            <div class="error-message">
              <ul>
                @for (error of errorMessage(); track error) {
                  <li>{{ error }}</li>
                }
              </ul>
            </div>
            <button
              type="button"
              class="icon-only-button"
              (click)="closeErrors()"
            >
              <app-icon name="close" />
            </button>
          </div>
        }
        <div class="form-actions">
          <div class="left-actions">
            @if (isSaving()) {
              <app-spinner></app-spinner>
            } @else {
              @if (isDirty()) {
                <button
                  type="submit"
                  [disabled]="isDupSchoolId() || schoolForm.invalid"
                >
                  Save
                </button>
              }
              <button type="button" (click)="cancel($event)">
                @if (isDirty()) {
                  Cancel
                } @else {
                  Close
                }
              </button>
            }
          </div>
          <div class="right-actions">
            <p class="timestamp">Last updated: {{ s.lastUpdated }}</p>
            @if (canDelete() && userIsAdmin()) {
              <button class="delete-button" (click)="deleteSchool($event)">
                <app-icon name="trash" fill="#000" />
                Delete
              </button>
            }
          </div>
        </div>
      </form>
    }
  </div>
} @else {
  <div class="edit-form">
    <div class="error-container">
      <div class="error-message">
        <p>No school is selected for editing.</p>
      </div>
    </div>
  </div>
}
