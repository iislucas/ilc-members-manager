@if (user(); as user) {
  <div class="profile-menu-container">
    <button class="avatar-button" (click)="toggleMenu()">
      @if (loadedImage()) {
        <img [src]="loadedImage()" alt="User Avatar" class="avatar-image" />
      } @else {
        <div class="avatar-initial" [style.backgroundColor]="avatarColor">
          {{ userInitial }}
        </div>
      }
    </button>

    @if (menuOpen()) {
      <div class="menu-overlay" (click)="menuOpen.set(false)"></div>
      <div class="menu-dropdown">
        <div class="user-info">
          <div class="display-name">{{ userDisplayName }}</div>
          <div class="email-chip">{{ userEmail }}</div>
        </div>

        @if (user.memberProfiles.length > 1) {
          <div class="profile-switcher">
            <div class="switcher-header">Switch Profile</div>
            <div class="profile-list">
              @for (profile of user.memberProfiles; track profile.id) {
                <div
                  class="profile-item"
                  [class.selected]="profile.id === user.member.id"
                  (click)="firebaseService.selectProfile(profile.id)"
                >
                  <div class="profile-name">{{ profile.name }}</div>
                  @if (profile.isAdmin) {
                    <span class="admin-badge">Admin</span>
                  }
                  @if (profile.id === user.member.id) {
                    <app-icon name="check" class="check-icon"></app-icon>
                  }
                </div>
              }
            </div>
          </div>
        }
        <button (click)="logout()">
          <app-icon name="logout"></app-icon>
          Logout
        </button>
      </div>
    }
  </div>
}
