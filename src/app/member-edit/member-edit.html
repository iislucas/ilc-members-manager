@let e = editableMember();

<div class="edit-form">
  <div
    class="edit-form-header"
    [class.can-toggle-collapse]="collapsable()"
    (click)="collapsable() && toggleCollapseState($event)"
  >
    <div class="identifier">
      @if (e.memberId) {
        <span>{{ e.memberId }}</span>
      }
      @if (e.instructorId) {
        <span>-{{ e.instructorId }}</span>
      }
    </div>
    <div class="name">
      @if (e.name.trim() === "") {
        [Name needs to be entered]
      }
      {{ e.name }}
      @if (isDirty()) {
        <span>*</span>
      }
    </div>
    @if (e.isAdmin) {
      <app-icon name="admin"></app-icon>
    }
    <div class="level">
      @if (e.studentLevel) {
        <span>S:{{ e.studentLevel }}</span>
      }
      @if (e.applicationLevel) {
        <span>A:{{ e.applicationLevel }}</span>
      }
    </div>
    <div class="city-and-country">
      @if (e.publicRegionOrCity) {
        <span class="city">{{ e.publicRegionOrCity }}, </span>
      } @else if (e.city) {
        <span class="city">{{ e.city }}, </span>
      }
      {{ e.country }}
    </div>
    @if (collapsable()) {
      <div class="unfold-button">
        <app-icon [name]="collapsed() ? 'expand_more' : 'expand_less'" />
      </div>
    }
  </div>

  @if (!collapsed()) {
    <form #memberForm="ngForm" (ngSubmit)="saveMember()">
      <div class="form-section">
        <h3>Contact</h3>
        <label for="name">Name</label>
        <div class="rhs">
          <input
            type="text"
            id="name"
            name="name"
            [(ngModel)]="e.name"
            (ngModelChange)="updateMember()"
            #name="ngModel"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            required
          />
          @if (name.invalid) {
            <div class="error-message">Name is required.</div>
          }
        </div>

        <label for="email">Email</label>
        <div class="rhs">
          <input
            type="email"
            id="email"
            name="email"
            [(ngModel)]="e.email"
            (ngModelChange)="updateMember()"
            #email="ngModel"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            required
            email
          />
          @if (isDupEmail()) {
            <div class="error-message">
              This email address is already in use.
            </div>
          } @else if (email.invalid) {
            <div class="error-message">Please enter a valid email address.</div>
          }
        </div>

        <label for="address" class="align-top">Address</label>
        <div class="rhs">
          <textarea
            id="address"
            name="address"
            [(ngModel)]="e.address"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
          ></textarea>
        </div>

        <label for="city">City</label>
        <div class="rhs">
          <input
            type="text"
            id="city"
            name="city"
            [(ngModel)]="e.city"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
          />
        </div>

        <label for="zipCode">Zip Code</label>
        <div class="rhs">
          <input
            type="text"
            id="zipCode"
            name="zipCode"
            [(ngModel)]="e.zipCode"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
          />
        </div>

        <label for="country">Country</label>
        <div class="rhs">
          <app-autocomplete
            [searchableSet]="membersService.countries"
            [displayFns]="countryDisplayFns"
            [inputBoxIsChip]="false"
            [placeholder]="'Search for a country'"
            [initSearchTerm]="e.country"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            (textUpdated)="e.country = $event; updateMember()"
          ></app-autocomplete>
          @if (countryWithCode(); as cc) {
            <div class="identifier-chip">{{ cc.id }}</div>
          } @else {
            <div class="error-message">invalid country</div>
          }
        </div>

        <label for="phone">Phone</label>
        <div class="rhs">
          <input
            type="text"
            id="phone"
            name="phone"
            [(ngModel)]="e.phone"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
          />
        </div>

        <label for="gender">Gender</label>
        <div class="rhs">
          <input
            type="text"
            id="gender"
            name="gender"
            [(ngModel)]="e.gender"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
          />
        </div>

        <label for="dateOfBirth">Date of Birth</label>
        <div class="rhs">
          <input
            class="date"
            type="date"
            id="dateOfBirth"
            name="dateOfBirth"
            placeholder="YYYY-MM-DD"
            [(ngModel)]="e.dateOfBirth"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsMemberSchoolManagerOrAdmin()"
          />
        </div>

        @if (userIsMemberOrAdmin()) {
          <h3>Primary Instructor</h3>
          <p class="note">
            Members choose who they consider to be their primary instructor, and
            can change it at any time. The primary instructor is visable only to
            the member, their current primary instructor, and ILC HQ.
          </p>
          <p class="note">
            The primary instructor can see the member's
            <span class="section-chip">Contacts Details</span>,
            <span class="section-chip">Membership Status & Level</span>, and
            <span class="section-chip">Instructor Status</span> (and if they are
            an instructor, their
            <span class="section-chip">Instructor Public Listing</span>). The
            primary instructor cannot edit the member's details.
          </p>

          <label for="sifuInstructorId" class="align-top"
            >Primary Instructor ID</label
          >
          <div class="rhs">
            <app-autocomplete
              name="Primary Instructor"
              [searchableSet]="membersService.instructors"
              [placeholder]="'Search for an instructor'"
              [displayFns]="instructorDisplayFns"
              [disabled]="!userIsMemberSchoolManagerOrAdmin()"
              [initSearchTerm]="e.sifuInstructorId"
              (textUpdated)="e.sifuInstructorId = $event; updateMember()"
            ></app-autocomplete>
            @if (e.sifuInstructorId === "") {
              <div class="note">No primary instructor set</div>
            } @else if (
              membersService.instructors.entriesMap().get(e.sifuInstructorId);
              as sifuData
            ) {
              <div class="note">{{ sifuData.name }}</div>
            } @else {
              <div class="error-message">
                invalid instructor ID:
                <span class="identifier-chip">{{ e.sifuInstructorId }}</span>
              </div>
            }
          </div>
        }

        @if (userIsMemberSchoolManagerOrAdmin()) {
          <h3>Primary School</h3>

          <p class="note">
            Member choose their primary school and can change it at any time. A
            member's primary school is visible only to the member, the current
            primary school and ILC HQ.
          </p>
          <p class="note">
            Administrators of the primary school can see and edit
            <span class="section-chip">Contacts Details</span>,
            <span class="section-chip">Membership Status & Level</span>, and
            <span class="section-chip">Instructor Status</span> (and if the
            member if an instructor, their
            <span class="section-chip">Instructor Public Listing</span>).
          </p>

          <label for="inSchoolId" class="align-top">Primary School ID</label>
          <div class="rhs">
            <app-autocomplete
              [searchableSet]="membersService.schools"
              [placeholder]="'Search for a school'"
              [displayFns]="schoolDisplayFns"
              [disabled]="!userIsMemberOrAdmin()"
              [initSearchTerm]="e.managingOrgId"
              (textUpdated)="e.managingOrgId = $event; updateMember()"
            ></app-autocomplete>
            @if (e.managingOrgId.trim() === "") {
              <div class="note">Primary School is ILC HQ</div>
            } @else if (
              membersService.schools.entriesMap().get(e.managingOrgId);
              as schoolData
            ) {
              <div class="note">{{ schoolData.schoolName }}</div>
            } @else {
              <div class="error-message">invalid school ID</div>
            }
          </div>
        }

        <h3>Membership Status & Level</h3>

        <label for="memberId">Member ID</label>
        <div class="rhs">
          @if (
            memberIdAssignment().kind === AssignKind.AssignNewAutoId &&
            !countryWithCode()
          ) {
            <div>
              <span class="error-message"
                >Please enter a country with a valid country code above, so that
              </span>
            </div>
          } @else {
            <app-id-assignment
              [initAssignment]="memberIdAssignment()"
              [canBeUnset]="false"
              [expectedNextId]="expectedNextMemberId()"
              [canEdit]="userIsAdmin()"
              (assignment)="handleMemberIdAssignmentChange($event)"
            ></app-id-assignment>
          }
        </div>

        <label for="membershipType">Type</label>
        <div class="rhs">
          <select
            id="membershipType"
            name="membershipType"
            [(ngModel)]="e.membershipType"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsSchoolManagerOrAdmin()"
            required
          >
            @for (type of membershipTypes; track type) {
              <option [value]="type">{{ type }}</option>
            }
          </select>
        </div>

        <label for="firstMembershipStarted">First Membership</label>
        <div class="rhs">
          <input
            class="date"
            type="date"
            id="firstMembershipStarted"
            name="firstMembershipStarted"
            placeholder="YYYY-MM-DD"
            [(ngModel)]="e.firstMembershipStarted"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsSchoolManagerOrAdmin()"
          />
        </div>

        <label for="lastRenewalDate">Last Renewal</label>
        <div class="rhs">
          <input
            class="date"
            type="date"
            id="lastRenewalDate"
            name="lastRenewalDate"
            placeholder="YYYY-MM-DD"
            [(ngModel)]="e.lastRenewalDate"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsSchoolManagerOrAdmin()"
          />
        </div>

        @if (e.membershipType !== MembershipType.Life) {
          <label for="currentMembershipExpires">Expires</label>
          <div class="rhs">
            <input
              class="date"
              type="date"
              id="currentMembershipExpires"
              name="currentMembershipExpires"
              placeholder="YYYY-MM-DD"
              [(ngModel)]="e.currentMembershipExpires"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsSchoolManagerOrAdmin()"
            />
          </div>
        }

        <label for="studentLevel">Student</label>
        <div class="rhs">
          <input
            type="text"
            id="studentLevel"
            name="studentLevel"
            [(ngModel)]="e.studentLevel"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsSchoolManagerOrAdmin()"
          />
        </div>

        <label for="applicationLevel">Application</label>
        <div class="rhs">
          <input
            type="text"
            id="applicationLevel"
            name="applicationLevel"
            [(ngModel)]="e.applicationLevel"
            (ngModelChange)="updateMember()"
            [disabled]="!userIsSchoolManagerOrAdmin()"
          />
        </div>

        <label for="masterLevels">Master</label>
        <div class="rhs">
          @for (level of masterLevels; track level) {
            <div class="masterLevel">
              <input
                id="masterLevels"
                name="masterLevels"
                type="checkbox"
                [checked]="e.mastersLevels.includes(level)"
                (change)="onMasterLevelChange(level, $event.target.checked)"
                [disabled]="!userIsAdmin()"
              />
              {{ level }}
            </div>
          }
        </div>

        <h3>Instructor Status</h3>
        <label for="instructorId">Instructor ID</label>
        <div class="rhs">
          <app-id-assignment
            name="instructorId"
            [initAssignment]="instructorIdAssignment()"
            [canBeUnset]="true"
            [expectedNextId]="expectedNextInstructorId()"
            [canEdit]="userIsAdmin()"
            (assignment)="handleInstructorIdAssignmentChange($event)"
          ></app-id-assignment>
        </div>

        @if (
          e.instructorId.trim() !== "" ||
          instructorIdAssignment().kind === AssignKind.AssignNewAutoId
        ) {
          <label for="instructorLicenseExpires">License Expires</label>
          <div class="rhs">
            <input
              class="date"
              type="date"
              id="instructorLicenseExpires"
              name="instructorLicenseExpires"
              placeholder="YYYY-MM-DD"
              [(ngModel)]="e.instructorLicenseExpires"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsSchoolManagerOrAdmin()"
            />
          </div>

          <h3>Instructor Public Listing</h3>

          <p class="note">
            While your instructor license is active, your Member ID, instructor
            ID, your graded levels, and the details in this section are public,
            and listed on the ILC website.
          </p>

          <label for="instructorWebsite">Website</label>
          <div class="rhs">
            <input
              type="text"
              id="instructorWebsite"
              name="instructorWebsite"
              [(ngModel)]="e.instructorWebsite"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            />
          </div>

          <label for="publicEmail">Public Email</label>
          <div class="rhs">
            <input
              type="email"
              id="publicEmail"
              name="publicEmail"
              [(ngModel)]="e.publicEmail"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            />
          </div>

          <label for="publicPhone">Public Phone</label>
          <div class="rhs">
            <input
              type="text"
              id="publicPhone"
              name="publicPhone"
              [(ngModel)]="e.publicPhone"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            />
          </div>

          <label for="publicRegionOrCity">Public Region/City</label>
          <div class="rhs">
            <input
              type="text"
              id="publicRegionOrCity"
              name="publicRegionOrCity"
              [(ngModel)]="e.publicRegionOrCity"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsMemberSchoolManagerOrAdmin()"
            />
          </div>
        }
        @if (userIsAdmin()) {
          <h3>Admin</h3>
          <label for="isAdmin">Is Admin</label>
          <div class="rhs">
            <input
              type="checkbox"
              id="isAdmin"
              name="isAdmin"
              [(ngModel)]="e.isAdmin"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsAdmin()"
            />
            <span class="note">(can edit all members)</span>
          </div>

          <label for="notes" class="align-top">Notes</label>
          <div class="rhs">
            <textarea
              id="notes"
              name="notes"
              [(ngModel)]="e.notes"
              (ngModelChange)="updateMember()"
              [disabled]="!userIsAdmin()"
            ></textarea>
          </div>
        }
      </div>

      @if (errorMessage().length > 0) {
        <div class="error-container">
          <div class="error-message">
            <ul>
              @for (error of errorMessage(); track error) {
                <li>{{ error }}</li>
              }
            </ul>
          </div>
          <button
            type="button"
            class="icon-only-button"
            (click)="closeErrors()"
          >
            <app-icon name="close" />
          </button>
        </div>
      }
      <div class="form-actions">
        <div class="left-actions">
          @if (isSaving()) {
            <app-spinner></app-spinner>
          } @else {
            @if (isDirty()) {
              <button
                type="submit"
                [disabled]="
                  isDupEmail() || isDupMemberId() || memberForm.invalid
                "
              >
                Save
              </button>
            }
            @if (collapsable()) {
              <button type="button" (click)="cancel($event)">
                @if (isDirty()) {
                  Cancel
                } @else {
                  Close
                }
              </button>
            }
          }
        </div>
        <div class="right-actions">
          <p class="timestamp">Last updated: {{ e.lastUpdated }}</p>

          @if (collapsable() && canDelete()) {
            <button class="delete-button" (click)="deleteMember($event)">
              <app-icon name="trash" fill="#000" />
              Delete
            </button>
          }
        </div>
      </div>
    </form>
  }
</div>
