<div class="page-layout">
  <div class="card">
    <h2>Schools</h2>
    <div class="import-export-actions">
      <div class="import">
        <h3>Import Schools</h3>
        <input
          type="file"
          (change)="onFileChange($event)"
          accept=".csv,.jsonl"
          [disabled]="stage() !== 'SELECT'"
        />
      </div>
      <div class="export">
        <h3>Export Schools</h3>
        <div class="export-buttons">
          <button (click)="membersService.downloadSchoolsAsCsv()">
            Download CSV
          </button>
          <button (click)="membersService.downloadSchoolsAsJsonL()">
            Download JSONL
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

@if (stage() !== "SELECT") {
  <div class="card workflow-container">
    <div class="header-actions">
      <h2>Importing Schools - Stage: {{ stage() }}</h2>
      @if (stage() !== "IMPORTING" && stage() !== "COMPLETED") {
        <button class="secondary" (click)="reset()">Cancel Import</button>
      } @else if (stage() === "COMPLETED") {
        <button (click)="reset()">Start Over</button>
      }
    </div>

    @switch (stage()) {
      @case ("MAPPING") {
        @let fieldMapping = mapping();
        <div class="mapping-table">
          <h3>Map Fields</h3>
          <p>
            Verify that the columns in your file match the correct fields. Check
            the examples below.
          </p>

          <div class="example-navigation">
            <button
              (click)="prevExample()"
              [disabled]="currentExampleIndex() === 0"
            >
              Previous Example
            </button>
            <span>
              Row {{ currentExampleIndex() + 1 }} of {{ parsedData().length }}
            </span>
            <button
              (click)="nextExample()"
              [disabled]="currentExampleIndex() === parsedData().length - 1"
            >
              Next Example
            </button>
          </div>

          <table>
            <thead>
              <tr>
                <th>School Field</th>
                <th>CSV/JSONL Header</th>
                <th>Example Value</th>
              </tr>
            </thead>
            <tbody>
              @for (field of fieldsToMap(); track $index) {
                <tr>
                  <td>{{ field }}</td>
                  <td>
                    <select (change)="setOneMappingValue(field, $event)">
                      <option value="">--Select Header--</option>
                      @for (header of headers(); track $index) {
                        <option
                          [value]="header"
                          [selected]="fieldMapping[field] === header"
                        >
                          {{ header }}
                        </option>
                      }
                    </select>
                  </td>
                  <td>
                    @if (fieldMapping[field]) {
                      {{ currentExampleRow()[fieldMapping[field]] }}
                    } @else {
                      <span class="no-mapping">--</span>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
          <div class="stage-actions">
            <button (click)="analyzeData()">Next: Analyze Changes</button>
          </div>
        </div>
      }
      @case ("ANALYZING") {
        <app-spinner>Analyzing Data...</app-spinner>
      }
      @case ("PREVIEW") {
        <div class="preview-stage">
          <h3>Review Changes</h3>
          @let delta = proposedChanges();
          <div class="summary-stats">
            <div
              class="stat new"
              [class.active]="selectedStatusFilter() === 'NEW'"
              (click)="setFilter('NEW')"
            >
              New: {{ delta.new.size }}
            </div>
            <div
              class="stat update"
              [class.active]="selectedStatusFilter() === 'UPDATE'"
              (click)="setFilter('UPDATE')"
            >
              Updates: {{ delta.updates.length }}
            </div>
            <div
              class="stat issue"
              [class.active]="selectedStatusFilter() === 'ISSUE'"
              (click)="setFilter('ISSUE')"
            >
              Issues: {{ delta.issues.length }}
            </div>
            <div
              class="stat unchanged"
              [class.active]="selectedStatusFilter() === 'UNCHANGED'"
              (click)="setFilter('UNCHANGED')"
            >
              Unchanged: {{ delta.unchanged.length }}
            </div>
            <div
              class="stat total"
              [class.active]="selectedStatusFilter() === 'ISSUE'"
              (click)="setFilter('ISSUE')"
            >
              Total:
              {{
              delta.new.size +
              delta.updates.length +
              delta.issues.length +
              delta.unchanged.length
              }}
            </div>
          </div>

          @if (filteredProposedChanges().length > 0) {
            <div class="change-viewer">
              <div class="example-navigation">
                <button
                  (click)="prevPreview()"
                  [disabled]="previewIndex() === 0"
                >
                  Previous Change
                </button>
                <span>
                  {{ previewIndex() + 1 }} of
                  {{ filteredProposedChanges().length }}
                </span>
                <button
                  (click)="nextPreview()"
                  [disabled]="
                    previewIndex() === filteredProposedChanges().length - 1
                  "
                >
                  Next Change
                </button>
              </div>

              @let change = currentPreviewChange();
              <div class="change-details card">
                <h4>
                  <span class="status-badge {{ change.status }}">
                    {{ change.status }}
                  </span>
                  {{ change.key }}
                </h4>

                @if (change.status === "ISSUE") {
                  <div class="issues-list card">
                    <h5>Mapping Issues Found:</h5>
                    <ul>
                      @for (issue of change.issues; track $index) {
                        <li>{{ issue }}</li>
                      }
                    </ul>
                  </div>
                }

                @if (change.status === "NEW" || change.status === "ISSUE") {
                  @if (change.status === "NEW") {
                    <p>This is a new record.</p>
                  } @else {
                    <p>
                      This record has mapping issues. Review below and consider
                      fixing your import file.
                    </p>
                  }
                  <pre>{{ change.newItem | json }}</pre>
                } @else if (change.status === "UPDATE") {
                  <table>
                    <thead>
                      <tr>
                        <th>Field</th>
                        <th>Old Value</th>
                        <th>New Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      @for (diff of change.diffs; track diff.field) {
                        <tr>
                          <td>{{ diff.field }}</td>
                          <td class="old-val">{{ diff.oldVal }}</td>
                          <td class="new-val">{{ diff.newVal }}</td>
                        </tr>
                      }
                    </tbody>
                  </table>
                } @else {
                  <p>No changes detected for this record.</p>
                }
              </div>
            </div>
          } @else {
            <p>No valid records found to import.</p>
          }

          <div class="stage-actions">
            <button class="primary" (click)="executeImportSchools()">
              Confirm & Import
            </button>
          </div>
        </div>
      }
      @case ("IMPORTING") {
        <app-spinner>
          Importing... {{ importProgress().current }} /
          {{ importProgress().total }}
        </app-spinner>
      }
      @case ("COMPLETED") {
        <div class="completed-stage">
          <h3>Import Complete!</h3>
          <p>Successfully processed {{ importProgress().total }} records.</p>
          @let counterResult = counterUpdateResult();
          @if (counterResult) {
          <div class="card counter-results" [class.success]="counterResult.success" [class.error]="!counterResult.success">
            @if (counterResult.success) {
            <h4>ID Counters Updated</h4>
            <p>System counters have been synchronized with the imported data.</p>
            <ul>
              @if (counterResult.updates?.schoolIdCounter) {
              <li>
                <strong>School ID Counter:</strong>
                {{ counterResult.updates?.schoolIdCounter }}
              </li>
              }
            </ul>
            } @else {
            <h4>Counter Update Failed</h4>
            <p>
              Failed to update system counters. Please contact support.
              <br />
              Error: {{ counterResult.error }}
            </p>
            }
          </div>
          }
        </div>
      }
    }
  </div>
}
