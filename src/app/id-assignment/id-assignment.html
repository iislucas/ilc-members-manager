@let cur = editedAssignment();
<div class="row">
  @if (cur.kind === AssignKind.AssignNewAutoId) {
    <span class="dynamic-identifier-chip"
      >Auto-assigned ID~{{ expectedNextId() }}</span
    >
    <span class="note">
      <span>(Chosen and assigned on save</span>
      @if (cur.curId) {
        <span>; previously: </span>
        <span class="identifier-chip">{{ cur.curId }}</span>
      }
      )
    </span>
  } @else if (cur.kind === AssignKind.UnchangedExistingId) {
    @if (cur.curId) {
      <span class="identifier-chip">{{ cur.curId }}</span>
    } @else {
      <span class="missing-identifier-chip">(No ID)</span>
      <button
        type="button"
        (click)="
          editedAssignment.set({
            kind: AssignKind.AssignNewAutoId,
            curId: cur.curId,
          })
        "
      >
        Assign
      </button>
    }
  } @else if (cur.kind === AssignKind.RemoveId) {
    <span>Removing ID: </span
    ><span class="identifier-chip">{{ cur.curId }}</span>
  } @else if (cur.kind === AssignKind.AssignNewManualId) {
    <input
      class="identifier-chip"
      type="text"
      [ngModel]="cur.newId"
      (ngModelChange)="
        editedAssignment.set({
          kind: AssignKind.AssignNewManualId,
          newId: $event,
          curId: cur.curId,
        })
      "
      [disabled]="!canEdit()"
    />
    @if (cur.curId === cur.newId) {
      <span class="note">(unchanged)</span>
    }
    @if (cur.curId && cur.curId !== cur.newId) {
      <span class="note">
        (previously:
        <span class="identifier-chip">{{ cur.curId }}</span
        >)
      </span>
    }
  }
  @if (canEdit()) {
    <div class="menu-container">
      <button
        type="button"
        class="icon-only-button"
        (click)="menuOpen.set(!menuOpen())"
      >
        <app-icon name="more_vert" />
      </button>
      @if (menuOpen()) {
        <div class="menu-overlay" (click)="menuOpen.set(false)"></div>
        <div class="menu">
          @if (cur.kind !== AssignKind.AssignNewManualId) {
            <div
              class="menu-item"
              (click)="
                editedAssignment.set({
                  kind: AssignKind.AssignNewManualId,
                  curId: cur.curId,
                  newId: cur.curId,
                })
              "
            >
              Edit Manually
            </div>
          }
          @if (
            cur.kind !== AssignKind.AssignNewAutoId &&
            (cur.kind === AssignKind.UnchangedExistingId && cur.curId
              ? true
              : false)
          ) {
            <div
              class="menu-item"
              (click)="
                editedAssignment.set({
                  kind: AssignKind.AssignNewAutoId,
                  curId: cur.curId,
                })
              "
            >
              Assign New Automatic ID
            </div>
          }
          @if (canBeUnset() && cur.curId && cur.kind !== AssignKind.RemoveId) {
            <div
              class="menu-item"
              (click)="
                editedAssignment.set({
                  kind: AssignKind.RemoveId,
                  curId: cur.curId,
                })
              "
            >
              Remove and unset ID
            </div>
          }
          @if (cur.kind !== AssignKind.UnchangedExistingId) {
            <div
              class="menu-item"
              (click)="
                editedAssignment.set({
                  kind: AssignKind.UnchangedExistingId,
                  curId: cur.curId,
                })
              "
            >
              Reset
            </div>
          }
        </div>
      }
    </div>
  }
</div>
